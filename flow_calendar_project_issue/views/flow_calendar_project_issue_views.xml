<?xml version="1.0"?>
<!-- Copyright 2017-2018 Nova Code (http://www.novacode.nl)
See LICENSE file for full licensing details. -->

<odoo>
    <data>
        <record id="view_flow_calendar_project_issue_calendar_event_search_form" model="ir.ui.view">
            <field name="name">flow_calendar_project_issue.calendar.event.search.form</field>
            <field name="model">calendar.event</field>
            <field name="arch" type="xml">
               <search string="Meetings">
                    <field name="flowcal_issue_project_id"/>
                    <field name="flowcal_issue_id"/>
                </search>
            </field>
        </record>

        <record id="act_project_project_issue_2_calendar_event_all" model="ir.actions.act_window">
            <field name="name">Meetings</field>
            <field name="res_model">calendar.event</field>
            <field name="view_mode">calendar,tree,form</field>
            <field name="context">{
                'search_default_flowcal_issue_id': [active_id],
                'default_flowcal_issue_id': active_id,
            }</field>
            <field name="search_view_id" ref="view_flow_calendar_project_issue_calendar_event_search_form"/>
        </record>

        <record id="flow_calendar_project_issue_view_calendar_event_form" model="ir.ui.view">
            <field name="name">flow_calendar_project_issue.calendar.event.form</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="calendar.view_calendar_event_form" />
            <field name="arch" type="xml">
                <xpath expr="//label[@for='partner_ids']" position="before">
                    <label for="flowcal_issue_project_id" string="Project"
                           attrs="{'invisible': [('flow_calendar_model', '!=', 'project.issue')]}" />
                    <h3>
                        <field name="flowcal_issue_project_id"
                               attrs="{'required': [('flow_calendar_model', '=', 'project.issue')],
                                      'invisible': [('flow_calendar_model', '!=', 'project.issue')]}"
                               placeholder="Select project..." class="oe_inline" style="min-width:700px;" />
                    </h3>
                    <label for="flowcal_issue_id" string="Issue"
                           attrs="{'invisible': ['|', ('flow_calendar_model', '!=', 'project.issue'), ('flowcal_issue_project_id', '=', False)]}" />
                    <h3>
                        <field name="flowcal_issue_id"
                               attrs="{'required': [('flow_calendar_model', '=', 'project.issue')],
                                      'invisible': ['|', ('flow_calendar_model', '!=', 'project.issue'), ('flowcal_issue_project_id', '=', False)]}"
                               placeholder="Select issue..." class="oe_inline" style="min-width:700px;" />
                    </h3>
                </xpath>
            </field>
        </record>

        <record id="flow_calendar_project_issue_view_calendar_event_form_popup" model="ir.ui.view">
            <field name="name">flow_calendar_project.calendar.event.form</field>
            <field name="model">calendar.event</field>
            <field name="inherit_id" ref="calendar.view_calendar_event_form_popup" />
            <field name="arch" type="xml">
                <field name="start_date" position="before">
                    <field name="flowcal_issue_id" string="Issue"
                           attrs="{'invisible': [('flow_calendar_model', '!=', 'project.issue')]}" />
                </field>
            </field>
        </record>

        <!-- Issue -->
        <record id="project_issue_form_view_flow_calendar" model="ir.ui.view">
            <field name="name">project.issue.form.view.flow_calendar_project</field>
            <field name="model">project.issue</field>
            <field name="inherit_id" ref="project_issue.project_issue_form_view" />
            <field name="arch" type="xml">
                <xpath expr="//form/header/field[@name='stage_id']" position="before">
                    <button name="action_flow_calendar_event_load_project_issue" type="object" string="Plan in Calendar" class="oe_highlight"/>
                </xpath>

                <xpath expr="//div[@name='button_box']" position="inside">
                    <button class="oe_stat_button" type="action"
                            name="%(act_project_project_issue_2_calendar_event_all)d" icon="fa-calendar">
                        <field string="Calendar Events" name="flowcal_event_count" widget="statinfo"/>
                    </button>
                </xpath>

                <field name="name" position="after">
                    <field name="id" invisible="1"/>
                </field>

                <xpath expr="//notebook/page[@name='extra_info']" position="before">
                    <page string="Calendar" attrs="{'invisible': [('id', '=', False)]}">
                        <field name="flowcal_event_ids" context="{'flowcal_issue_id': id}">
                            <tree name="calendar_events" string="Calendar Events" editable="bottom" default_order="start_datetime asc">
                                <field name="name"/>
                                <field name="start" required="1"/>
                                <field name="stop" required="1"/>
                                <field name="duration" readonly="1"/>
                                <field name="partner_ids" widget="many2many_tags"/>
                                <field name="state" invisible="1"/>
                                <field name="attendee_status"/>
                                <button type="object" name="action_flow_calendar_event_from_project_issue" string="Event"/>
                            </tree>
                        </field>
                    </page>
                </xpath>
            </field>
        </record>
    </data>
</odoo>
